> [Understanding the Transform Function in Pandas](https://link.jianshu.com?t=http://pbpython.com/pandas_transform.html)

- Pandas具有丰富的功能让我们探索，`transform`就是其中之一，利用它可以高效地汇总数据。
- [Python Data Science Handbook](https://link.jianshu.com?t=http://amzn.to/2oy9jbR) 是一个关于pandas的优秀资源。
- 在该书的描述中，`transform`是与`groupby`（pandas中最有用的操作之一）组合使用的。一般情况下，我们在`groupby`之后使用`aggregate , filter 或 apply`来汇总数据，`transform`可能稍难理解。
- 该书对应的github资源 jupyter [notebooks](https://link.jianshu.com?t=https://github.com/jakevdp/PythonDataScienceHandbook/tree/master/notebooks)里的内容可能对理解[transform](https://link.jianshu.com?t=https://github.com/jakevdp/PythonDataScienceHandbook/blob/master/notebooks/03.08-Aggregation-and-Grouping.ipynb)的独特作用有所帮助。

> aggregation会返回数据的缩减版本，而transformation能返回完整数据的某一变换版本供我们重组。这样的transformation，输出的形状和输入一致。一个常见的例子是通过减去分组平均值来居中数据。

- 接下来，我们利用[简单的11行销售数据](https://link.jianshu.com?t=https://github.com/chris1610/pbpython/blob/master/data/sales_transactions.xlsx?raw=true)实际做一个其它用途的例子来掌握`transform`。

### 实践

- 加载数据



```dart
import pandas as pd

df = pd.read_excel("sales_transactions.xlsx")
```

- 查看数据

![img](https:////upload-images.jianshu.io/upload_images/2422746-2e64e208c4c05467.png?imageMogr2/auto-orient/strip|imageView2/2/w/608/format/webp)

- 可以看到数据包含了不同的订单（order），以及订单里的不同商品的数量（quantity）、单价（unit price）和总价（ext price）
- 现在我们的任务是为数据表添加一列，表示不同商品在所在订单的价钱占比。
- 首先我们要获得每个订单的总花费。`groupby`可以实现。



```bash
df.groupby('order')["ext price"].sum()
```



```css
order
10001     576.12
10005    8185.49
10006    3724.49
Name: ext price, dtype: float64
```

![img](https:////upload-images.jianshu.io/upload_images/2422746-310f1353a2e7882a.png?imageMogr2/auto-orient/strip|imageView2/2/w/1000/format/webp)

- 这些新得到的数据如何与原始数据帧结合呢？



```bash
order_total = df.groupby('order')["ext price"].sum().rename("Order_Total").reset_index()

df_1 = df.merge(order_total)
df_1["Percent_of_Order"] = df_1["ext price"] / df_1["Order_Total"]
```

![img](https:////upload-images.jianshu.io/upload_images/2422746-e6236cce89737d88.png?imageMogr2/auto-orient/strip|imageView2/2/w/234/format/webp)



![img](https:////upload-images.jianshu.io/upload_images/2422746-786a4f14cda25514.png?imageMogr2/auto-orient/strip|imageView2/2/w/805/format/webp)

- 我们实现了目标（还多加了一列订单总额），但是步骤比较多，有没有更好的办法呢？——主角出场:）

#### Transform

- 我们先试下



```bash
df.groupby('order')["ext price"].transform('sum')
```



```css
0      576.12
1      576.12
2      576.12
3     8185.49
4     8185.49
5     8185.49
6     8185.49
7     8185.49
8     3724.49
9     3724.49
10    3724.49
11    3724.49
dtype: float64
```

- 不再是只显示3个订单的对应项，而是保持了与原始数据集相同数量的项目，这样就很好继续了。这就是`transform`的独特之处。



```bash
df["Order_Total"] = df.groupby('order')["ext price"].transform('sum')
df["Percent_of_Order"] = df["ext price"] / df["Order_Total"]
```

- 甚至可以一步：



```bash
df["Percent_of_Order"] = df["ext price"] / df.groupby('order')["ext price"].transform('sum')
```

![img](https:////upload-images.jianshu.io/upload_images/2422746-a8e558dd8affe016.png?imageMogr2/auto-orient/strip|imageView2/2/w/724/format/webp)

![img](https:////upload-images.jianshu.io/upload_images/2422746-c25ab9ebb27aef44.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp)



66人点赞



[Python]()





作者：treelake
链接：https://www.jianshu.com/p/509d7b97088c
来源：简书
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。